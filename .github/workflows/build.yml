name: Build Slang (Static)

on:
  workflow_dispatch:
    inputs:
      slang_tag:
        description: "Slang tag to build"
        required: false
        default: "v2026.1.2"

jobs:
  build:
    name: Build (${{ matrix.os_label }} / ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - runner: ubuntu-latest
            os_label: linux
            arch: x86_64
          - runner: ubuntu-latest
            os_label: linux
            arch: aarch64

          # macOS
          - runner: macos-latest
            os_label: macos
            arch: x86_64
          - runner: macos-latest
            os_label: macos
            arch: aarch64

          # Windows
          - runner: windows-latest
            os_label: windows
            arch: x86_64
          # - runner: windows-latest
          #   os_label: windows
          #   arch: aarch64

    env:
      TAG: ${{ github.event.inputs.slang_tag }}
      OS_LABEL: ${{ matrix.os_label }}
      ARCH: ${{ matrix.arch }}
      SCCACHE_GHA_ENABLED: "true"

      SLANG_CMAKE_FLAGS: >
        -DSLANG_LIB_TYPE=STATIC
        -DSLANG_ENABLE_GFX=FALSE
        -DSLANG_ENABLE_SLANGD=FALSE
        -DSLANG_ENABLE_SLANGC=TRUE
        -DSLANG_ENABLE_SLANGI=FALSE
        -DSLANG_ENABLE_SLANGRT=FALSE
        -DSLANG_ENABLE_SLANG_GLSLANG=FALSE
        -DSLANG_ENABLE_TESTS=FALSE
        -DSLANG_ENABLE_EXAMPLES=FALSE
        -DSLANG_ENABLE_CUDA=FALSE
        -DSLANG_ENABLE_OPTIX=FALSE
        -DSLANG_ENABLE_NVAPI=FALSE
        -DSLANG_ENABLE_AFTERMATH=FALSE
        -DSLANG_ENABLE_XLIB=FALSE
        -DSLANG_ENABLE_SLANG_RHI=FALSE
        -DSLANG_EMBED_CORE_MODULE_SOURCE=OFF
        -DSLANG_ENABLE_RELEASE_LTO=ON
        -DCMAKE_C_COMPILER_LAUNCHER=sccache
        -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

    steps:
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Checkout slang
        uses: actions/checkout@v4
        with:
          repository: shader-slang/slang
          ref: ${{ env.TAG }}
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies + sccache
        shell: bash
        run: |
          set -eux
          if [ "$OS_LABEL" = "linux" ]; then
            sudo apt-get update
            sudo apt-get install -y \
              cmake ninja-build python3 zip unzip git build-essential sccache
          elif [ "$OS_LABEL" = "macos" ]; then
            brew update
            brew install cmake ninja python3 sccache zip
          else
            choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
            choco install -y ninja python3 sccache zip
          fi

      - name: Build
        shell: bash
        run: |
          set -eux

          rm -rf "build"

          cmake_args=(-S . -B "build")

          if [ "$OS_LABEL" = "windows" ]; then
            cmake_args+=(-G "Visual Studio 17 2022")
            if [ "$ARCH" = "aarch64" ]; then
              cmake_args+=(-A ARM64)
            else
              cmake_args+=(-A x64)
            fi
          else
            cmake_args+=(-G Ninja)
          fi

          cmake_args+=($SLANG_CMAKE_FLAGS)

          cmake "${cmake_args[@]}"

          cmake --build --preset releaseWithDebugInfo
          cmake --build --preset minSizeRel

      - name: Package build directories
        shell: bash
        run: |
          set -eux

          debug_dir="build/RelWithDebInfo"
          release_dir="build/MinSizeRel"

          if [ ! -d "$debug_dir" ] || [ ! -d "$release_dir" ]; then
            echo "Expected build directories not found!"
            ls -l "build"
            exit 1
          fi

          zip_debug="slang-${TAG}-${OS_LABEL}-${ARCH}-debug-info.zip"
          zip_release="slang-${TAG}-${OS_LABEL}-${ARCH}.zip"

          (cd "$debug_dir" && zip -r "../../$zip_debug" .)
          (cd "$release_dir" && zip -r "../../$zip_release" .)

      - name: Upload MinSizeRel artifact
        uses: actions/upload-artifact@v4
        with:
          name: slang-${{ env.TAG }}-${{ matrix.os_label }}-${{ matrix.arch }}
          path: slang-${{ env.TAG }}-${{ matrix.os_label }}-${{ matrix.arch }}.zip

      - name: Upload RelWithDebInfo artifact
        uses: actions/upload-artifact@v4
        with:
          name: slang-${{ env.TAG }}-${{ matrix.os_label }}-${{ matrix.arch }}-debug-info
          path: slang-${{ env.TAG }}-${{ matrix.os_label }}-${{ matrix.arch }}-debug-info.zip

  publish:
    name: Publish GitHub release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.slang_tag }}
          release_name: Slang ${{ github.event.inputs.slang_tag }} (static)
          draft: false
          prerelease: false

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -eux
          for f in artifacts/**/*.zip; do
            name=$(basename "$f")
            curl -sS \
              -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/zip" \
              --data-binary @"$f" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ steps.release.outputs.id }}/assets?name=$name"
          done
